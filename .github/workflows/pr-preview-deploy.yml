name: PR Documentation Preview with Deploy

on:
  pull_request_target:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  build-and-deploy-preview:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Antora
      run: npm install -g @antora/cli@3.1 @antora/site-generator@3.1
    
    - name: Create cache directory
      run: mkdir -p ./.cache/antora
    
    - name: Build documentation
      run: |
        echo "Building Antora documentation..."
        antora --stacktrace default-site.yml
    
    - name: Deploy PR Preview to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./www
        destination_dir: pr-${{ github.event.number }}
        keep_files: true
        enable_jekyll: false
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
    
    - name: Find PR comment
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: 'Documentation Preview'
    
    - name: Create or update PR comment
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          ## ğŸ“– Documentation Preview
          
          The documentation preview for this PR has been built and deployed successfully!
          
          **ğŸ“‹ Preview Details:**
          - **PR Number:** #${{ github.event.pull_request.number }}
          - **Commit:** ${{ github.event.pull_request.head.sha }}
          - **Build Time:** ${{ steps.date.outputs.date }}
          
          **ğŸŒ Live Preview:**
          [**ğŸ”— View Documentation Preview**](https://redhat-ads-tech.github.io/rhads-enablement-l3-rhel/pr-${{ github.event.number }}/)
          
          **ğŸ“¥ Alternative - Download Artifact:**
          You can also download the generated documentation from the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          
          **ğŸ”„ This comment will be updated automatically when new commits are pushed to this PR.**
          
          ---
          *Preview will be available for 30 days or until the PR is closed.* 
